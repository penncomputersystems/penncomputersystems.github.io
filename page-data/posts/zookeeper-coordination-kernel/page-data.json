{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/zookeeper-coordination-kernel","result":{"data":{"markdownRemark":{"id":"7fdc1f47-16f9-54d4-a22f-9177f4105d60","html":"<p>A key challenge commonly faced in distributed systems design has to do with\nprocess coordination. Many large scale systems require efficient ways to coordinate\nbetween servers, and there are variations on the purpose of coordination (e.g. node configuration,\ngroup membership etc.) each with different requirements. Thus, developing a service\nbest suited for a particular application from scratch can be challenging and time consuming.</p>\n<p>Introducing ZooKeeper, first described in a\n<a href=\"https://www.usenix.org/legacy/event/atc10/tech/full_papers/Hunt.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">paper</a>\npublished by Yahoo!, a service used for coordinating processes in distributed systems.\nAuthors of ZooKeeper call it a <em>coordination kernel</em> as it exposes an interface\nthat allows clients to build coordination primitives (e.g. locks, condition variables)\nwithout changes to the underlying service, much like an operating system provides\nsystem calls for user-space processes. Contrast this with services that targets a specific use\ncase, such as the Akamai Configuration Management System for node configuration, or\nthe Amazon Simple Queue Service for queuing, ZooKeeper is much more flexible, which\nallows clients to build arbitrary primitives for specific use cases.</p>\n<blockquote>\n<p>“Distributed systems are a zoo. They are chaotic and hard to manage, and ZooKeeper is meant to keep them\nunder control.”</p>\n<div style=\"text-align: right\"> - on the origin of the name \"ZooKeeper\" </div>\n</blockquote>\n<p>One of the advantages of ZooKeeper is the emphasis on being “wait-free”, meaning that\nits implementation does not make use of blocking primitives, such as locks. This\navoids common problems where slow/faulty clients become the bottleneck in the system.\nYet surprisingly, this does not prevent the implementation of locks as we will see later on.\nThat being said, in order to be an effective service for coordination, ZooKeeper\nmust provide some reasonable guarantees.</p>\n<p>In this article, we will discuss the basic ZooKeeper API and its semantics,\nthe guarantees that come with ZooKeeper, some example implementations of common\nprimitives, as well as discuss the underlying implementation of ZooKeeper itself.</p>\n<h1 id=\"the-zookeeper-service\" style=\"position:relative;\"><a href=\"#the-zookeeper-service\" aria-label=\"the zookeeper service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The ZooKeeper Service</h1>\n<h2 id=\"the-abstraction\" style=\"position:relative;\"><a href=\"#the-abstraction\" aria-label=\"the abstraction permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Abstraction</h2>\n<p>The ZooKeeper service is usually composed of an ensemble of ZooKeeper servers.\nClients of the service (which are processes that you want to coordinate) connect\nto the service by obtaining a session handle from a particular server, but the\nhandle itself persist across ZooKeeper servers, which allow clients to transparently\nmove from one server to another.</p>\n<p>The abstraction that ZooKeeper provides is a set of data nodes, organized\naccording to a hierarchical name space, which is a close analogue of\nfiles in a typical filesystem. Each data node is stored in-memory, and can\ncontain arbitrary data, but is not designed for data storage, but more for\ncoordination metadata.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8d78043f7a4587b6e8d7604f4d00c9b/33d1d/example-namespace.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUElEQVQoz3VT266CQAzk/z/smBwfPCo37yaC+iCgIuAFndNZWWQhNmm26W6HzrRY+GKv10u5jmlFUaB8PIycPrVZX4Gq8/l8qnwSx/B9H7PpzHjXBrZMoE+sgbSFQQjbtjEaDlWnzTq+7QBW12gyyPMcSZIgTVM8hGqWZbjdbigkz9zpdOqws8z23/Fuu8V6tcZEKI6GI9zv947GQRDAdV2RYIrVconLJft0aOggfr1eEYYhPCmwx2Ocz2d1T2paiv1uJ/celouFgF0Ug46G+kwrAFLMxfkBxu231LVDuTmpzWYD13FQlqX64mI+V7l3R3s4tlMPhDXH47GzYgZlR8D6v30FxoH8DQZqskozAe799BAdDjX9KIqM9ak7pJGW73lKYALG8tj3fAXEYmpK8Fj2UQ+JNe3lrgFJM6v0IiDXg11yRQjIPJ2Umzva/lP+AXklVshW1h2DAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f8d78043f7a4587b6e8d7604f4d00c9b/8ac56/example-namespace.webp 240w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/d3be9/example-namespace.webp 480w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/e46b2/example-namespace.webp 960w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/7ed5b/example-namespace.webp 1150w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f8d78043f7a4587b6e8d7604f4d00c9b/8ff5a/example-namespace.png 240w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/e85cb/example-namespace.png 480w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/d9199/example-namespace.png 960w,\n/static/f8d78043f7a4587b6e8d7604f4d00c9b/33d1d/example-namespace.png 1150w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f8d78043f7a4587b6e8d7604f4d00c9b/d9199/example-namespace.png\"\n            alt=\"Illustration of an example of ZooKeeper state\"\n            title=\"Illustration of an example of ZooKeeper state\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>In particular, there are two types of data nodes that can be created:</p>\n<ul>\n<li><strong>Regular</strong>: Clients create and delete regular nodes explictly.</li>\n<li><strong>Ephemeral</strong>: Clients create ephemeral nodes and can delete\nthem explicitly, but the system can remove such nodes automatically\nwhen the session that created the node terminates.</li>\n</ul>\n<p>Note that ephemeral nodes can be useful for implementing certain primitives that are\ndependent on whether specific nodes are connected (e.g. leader election,\ngroup membership).</p>\n<p>Further, each data node can be created with the <em>sequential</em> flag. Nodes\ncreated with the flag will have a monotonically increasing counter assigned\nand appended to its name. This can be useful for implementing primitives\nthat require queuing.</p>\n<p>Finally, ZooKeeper also provides a watching facility, much like\nsubscription services/change streams, which allows clients to\nreceive a notification of a change without polling. This can be useful\nfor implementing primitives that require event waiting or callbacks.</p>\n<h2 id=\"client-api\" style=\"position:relative;\"><a href=\"#client-api\" aria-label=\"client api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Client API</h2>\n<p>Clients of the ZooKeeper service issue requests through the client API. We present\na basic subset of the API discussed in the paper, which we will use to build\nsome primitives later on.</p>\n<ol>\n<li><code class=\"language-text\">create(path, data, flags)</code>: Creates a data node with path name <code class=\"language-text\">path</code>,\nstores <code class=\"language-text\">data[]</code> and returns the name of the data node. <code class=\"language-text\">flags</code> allow\na client to select between regular and ephemeral data nodes, as well as make\nthe data node sequential.</li>\n<li><code class=\"language-text\">delete(path, version)</code>: Deletes the data node at <code class=\"language-text\">path</code> if the version\nnumber matches the data node.</li>\n<li><code class=\"language-text\">exists(path, watch)</code>: Returns whether a data node at <code class=\"language-text\">path</code> exists. The\n<code class=\"language-text\">watch</code> flag enables the client to watch the data node for changes.</li>\n<li><code class=\"language-text\">getData(path, watch)</code>: Returns the data associated with the data node. The\n<code class=\"language-text\">watch</code> flag enables the client to watch the data node for changes.</li>\n<li><code class=\"language-text\">setData(path, data, version)</code>: Writes <code class=\"language-text\">data[]</code> to the data node at <code class=\"language-text\">path</code>\nif the version number matches the data node.</li>\n<li><code class=\"language-text\">getChildren(path, watch)</code>: Returns the set of children names of a data node.</li>\n<li><code class=\"language-text\">sync(path)</code>: Waits for all updates pending at the start of the operation\nto propagate to the server that the client is connected to.</li>\n</ol>\n<p>Note that these requests can be issued asynchronously. In particular, <em>multiple</em>\nrequests can be issued from the same client at a time.</p>\n<h2 id=\"zookeeper-guarantees\" style=\"position:relative;\"><a href=\"#zookeeper-guarantees\" aria-label=\"zookeeper guarantees permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ZooKeeper Guarantees</h2>\n<p>A coordination kernel would be next to useless without reasonable guarantees about\nhow it behaves when operations interleave. Thus, ZooKeeper provides the following\nguarantees.</p>\n<ul>\n<li><strong>Linearizable writes</strong>: All requests that update the global state of the\nZooKeeper ensemble are serializable and respect precedence. This means that the\noutcome of a set of possibly interleaving writes is equal to the outcome of\nthose writes executing serially. Further, write requests are always processed in\norder.</li>\n<li><strong>FIFO client order</strong>: All requests from a given client are executed\nin the order that they were sent by the client.</li>\n</ul>\n<p>Note that ZooKeeper was designed for read-heavy workloads (target read-to-write ratios\nrange from 2:1 to 100:1), thus ZooKeeper does <strong>not</strong> support linearizable reads!\nIn other words, reads from a given server can be stale, meaning that updates\nthat are committed to global state might not be visible. This is a\nconscious design decision and does not affect the correctness of the primitives\nwe can build with ZooKeeper if done carefully. We will discuss why this occurs\nwhen we discuss the implementation details of the ZooKeeper service later on.</p>\n<h1 id=\"basic-coordination-primitives\" style=\"position:relative;\"><a href=\"#basic-coordination-primitives\" aria-label=\"basic coordination primitives permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Basic Coordination Primitives</h1>\n<p>Having seen the abstraction, client API and guarantees of ZooKeeper, let us\nput it in action and build a couple of simple coordination primitives with ZooKeeper,\nnamely read-write locks and leader election.</p>\n<h2 id=\"readwrite-locks\" style=\"position:relative;\"><a href=\"#readwrite-locks\" aria-label=\"readwrite locks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Read/Write Locks</h2>\n<p>A read-write lock is a locking primitive allows multiple readers to hold the lock\n<strong>or</strong> exactly one writer to hold the lock at one point in time. To build such\na primitive, we create a regular data node at path <code class=\"language-text\">l</code> to hold metadata for\na particular lock. Then, for each client wishing to hold the lock for reading or\nwriting, we line them up by creating a <em>sequential</em> data node, and watch the\ndata node ordered just in front of the newly created node for changes.\nThe following pseudocode describes the logic in more detail.</p>\n<p><strong>Write Lock</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 n = create(l + “/write-”, EPHEMERAL|SEQUENTIAL)\n2 C = getChildren(l, false)\n3 if n is lowest data node in C, exit\n4 p = data node in C ordered just before n\n5 if exists(p, true) wait for event\n6 goto 2</code></pre></div>\n<p><strong>Read Lock</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 n = create(l + “/read-”, EPHEMERAL|SEQUENTIAL)\n2 C = getChildren(l, false)\n3 if no write data nodes lower than n in C, exit\n4 p = write data node in C ordered just before n\n5 if exists(p, true) wait for event\n6 goto 3</code></pre></div>\n<p><strong>Unlock</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 delete(n)</code></pre></div>\n<p>A couple of interesting points to note:</p>\n<ul>\n<li>The <em>sequential</em> flag came in useful to implement queuing for locks. Since reads\ncan easily be stale, allowing the server to choose the concrete data node path\nprevents race conditions that typically happen due to the lack of atomicity\nof a read followed by a write.</li>\n<li>The <em>ephemeral</em> flag made sure that clients that disconnect due to a failure or\nwithout releasing the lock on exit will not hold the lock indefinitely.</li>\n<li>The familiar loop to check whether a lock has been obtained by the client is\nimportant, since it is possible that the previous lock request in queue was abandoned\n(say by a disconnection) while an earlier client is still holding the lock.</li>\n<li>The watch facility provided by ZooKeeper is a neat way to notify a client that\nthey can attempt to obtain the lock without polling.</li>\n<li>There is no <a href=\"https://en.wikipedia.org/wiki/Thundering_herd_problem\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">herd effect</a>\nsince exactly one client is woken up when a lock is released.</li>\n<li>Even though ZooKeeper does not support linearizable reads, we can be confident that the list\nof children <code class=\"language-text\">C</code> obtained above does not miss any clients that came before, since it is preceded\nby a write operation.\nIf the write operation resolves, the read operation that follows must be as recent\nas the state right after the write operation.</li>\n</ul>\n<h2 id=\"leader-election\" style=\"position:relative;\"><a href=\"#leader-election\" aria-label=\"leader election permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Leader Election</h2>\n<p>Leader elections are commonly used to coordinate between multiple processes\nin distributed systems, where a leader is “elected” to make decisions which\n“followers” obey. <a href=\"https://penncomputersystems.github.io/posts/raft-consensus\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Raft</a>\nmakes use of leader elections for consistent log replication, and ZooKeeper\nitself follows a leader replication model, as we will see later.</p>\n<p>To build such a primitive, we create a regular data node at path <code class=\"language-text\">l</code> to\nhold metadata for the elction. Then, we again create a <em>sequential</em> node\nat <code class=\"language-text\">l</code>, and watch for changes of the preceding data node, and assume the role\nof leader if it ever gets deleted. The following pseudocode describes the\nidea more concretely.</p>\n<p><strong>Election</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">1 n = create(l + &quot;/n-&quot;, EPHEMEREAL|SEQUENTIAL)\n2 C = getChildren(l, false)\n3 if n is lowest data node in C, assume leader, exit\n4 p = data node in C ordered just before n\n5 if exists(p, true) wait for event\n6 goto 2</code></pre></div>\n<p>The underlying idea for implementing leader election is similar to how\nwe implemented the read/write lock above. Can you spot how we avoided the\nherd effect? Which guarantees of ZooKeeper prevent two clients from thinking\nthey are both the leaders?</p>\n<h1 id=\"zookeeper-implementation\" style=\"position:relative;\"><a href=\"#zookeeper-implementation\" aria-label=\"zookeeper implementation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ZooKeeper Implementation</h1>\n<p>Finally, we discuss some of the interesting aspects of the implementation of\nZooKeeper itself, namely how it provides its guarantees, and how it is optimized\nfor real-world throughputs.</p>\n<h2 id=\"replicated-databases\" style=\"position:relative;\"><a href=\"#replicated-databases\" aria-label=\"replicated databases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Replicated Databases</h2>\n<p>As discussed, a ZooKeeper service is usually composed of multiple servers\nworking as an ensemble. This allows ZooKeeper to provide high availability\nby replicating the data nodes on each server. In order to maintain consistency\nbetween servers, ZooKeeper opts for a common strategy for horizontal scaling,\nnamely leader replication. More specifically, a server is selected as the\n<em>leader</em> and the other servers are <em>followers</em>. Further, writes are always\nrouted through the reader and commits when there is a quorum. Note\nthat reads on the other hand can be served by a local replica which may be\nout-of-date and stale (which is why ZooKeeper does not support linearizable reads),\nbut this allows for higher read throughput.</p>\n<h2 id=\"zab-an-atomic-broadcast-protocol\" style=\"position:relative;\"><a href=\"#zab-an-atomic-broadcast-protocol\" aria-label=\"zab an atomic broadcast protocol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Zab: An Atomic Broadcast Protocol</h2>\n<p>ZooKeeper makes use of <em>Zab</em>, an atomic broadcast protocol to provide\nthe strong guarantees as described previously. At a high level, Zab\nmakes use of a majority quorum to commit a proposal to a state change,\nand guarantees that changes are delivered in order that they were sent\nand are atomic. ZooKeeper also makes use of <em>Zab</em> for fault tolerance,\nand uses the protocol to deliver “catch-up” messages since the last\nsnapshot in the event of a server failure.</p>\n<p>An important point about Zab is that each state change is recorded\nin an <em>idempotent</em> transaction. In other words, applying a particular\ntransaction multiple times will not affect the final state of the system.\nNote that this often requires the leader to execute client requests locally\nbefore proposing a change. For instance, an operation to increment the value\nof the data node at <code class=\"language-text\">path</code> has to be converted to setting the value of the\ndata node to some value to preserve idempotency.</p>\n<p>For more details and theoretical proofs of correctness of <em>Zab</em>, check out\nthe paper <a href=\"https://marcoserafini.github.io/papers/zab.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a>.</p>\n<h2 id=\"fuzzy-snapshots\" style=\"position:relative;\"><a href=\"#fuzzy-snapshots\" aria-label=\"fuzzy snapshots permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fuzzy Snapshots</h2>\n<p>Since the data nodes are stored in-memory, each replica has to take snapshots\nperiodically as replaying all transactions from the leader would potentially\nbe too time consuming. Recall that ZooKeeper is <em>wait-free</em>, so the snapshots\nare <em>fuzzy snapshots</em>, since the implementation does not take a lock on the\nstate of a particular replica. Interestingly, a resulting snapshot may not correspond\nto the state of ZooKeeper at any point in time (can you think of a series of\ntransactions and snapshot procedure that results in this behavior?). But,\nsince transactions are idempotent, a replica can easily apply them as long as\nthe transactions are stored in the correct order.</p>\n<h1 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h1>\n<p>ZooKeeper was initially developed at Yahoo! and used for a variety of Yahoo!\nservices such as the search engine crawler and their distributed pub-sub system,\nbut has seen many more use cases ever since. For instance, the Apache Software\nFoundation has developed <a href=\"https://zookeeper.apache.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Apache ZooKeeper</a>\nas an open-source version of ZooKeeper and is widely used for many production\napplications including Apache Hadoop and Kafka as well as companies including\nYelp, Reddit, Facebook, Twitter etc. Its simple interface, reasonable\nconsistency guarantees, and flexible abstractions provides the user with the\nability to tailor specific primitives that fit the requirements of a particular system.</p>\n<p><em>P.S.</em> Personally, I first heard about ZooKeeper from an interesting\n<a href=\"https://www.youtube.com/watch?v=mMuk8Rn9HBg\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Youtube video</a> from one of my favorite programming channels\non building an asynchronous ZooKeeper client in Rust, which is in\nmy opinion a great way to get hands-on experience with interacting with ZooKeeper!</p>","fields":{"slug":"/posts/zookeeper-coordination-kernel","tagSlugs":["/tag/distributed-systems/"]},"frontmatter":{"author":"Yingxuan Eng","date":"2021-02-18","description":"ZooKeeper is a coordination kernel that provides a simple API along with powerful guarantees that provides clients an easy way to build concurrency primitives for coordinating large-scale distributed processes.","tags":["Distributed Systems"],"title":"ZooKeeper: A Coordination Kernel","socialImage":{"publicURL":"/static/6e164f6694f44d451de33f7360de8307/zookeeper.png"}}}},"pageContext":{"slug":"/posts/zookeeper-coordination-kernel"}},"staticQueryHashes":["251939775","401334301","825871152"]}